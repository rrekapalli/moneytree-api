<!-- Search and Sort Controls -->
<div class="search-section">
  <label for="stock-search" class="sr-only">Search stocks</label>
  <div class="search-controls">
    <span class="p-input-icon-left search-input-wrapper">
      <i class="pi pi-search" aria-hidden="true"></i>
      <input 
        id="stock-search"
        type="text" 
        pInputText 
        [(ngModel)]="searchText" 
        (ngModelChange)="onSearchChange()"
        placeholder="Search..." 
        class="search-input"
        aria-label="Search stocks by name or symbol" />
    </span>
    <p-select 
      [(ngModel)]="sortField"
      [options]="sortOptions"
      (ngModelChange)="onSortFieldChange()"
      optionLabel="label"
      optionValue="value"
      appendTo="body"
      class="sort-dropdown"
      [pTooltip]="getSortLabel()"
      tooltipPosition="top"
      aria-label="Sort stocks">
      <ng-template pTemplate="selectedItem">
        <i class="pi pi-sort-alt"></i>
      </ng-template>
    </p-select>
  </div>
</div>

<!-- Loading indicator -->
<div *ngIf="isLoadingStocks" class="loading-container">
  <div class="loading-content">
    <i class="pi pi-spin pi-spinner text-4xl text-primary"></i>
    <span class="text-lg text-600 mt-3">Loading instruments...</span>
  </div>
</div>

<!-- Main stock table -->
<p-table
            *ngIf="!isLoadingStocks"
            [value]="filteredStocks"
            [globalFilterFields]="['symbol', 'companyName', 'industry', 'sector']"
            [scrollable]="true"
            [scrollHeight]="tableScrollHeight"
            styleClass="p-datatable-sm"
            selectionMode="single">

        <ng-template pTemplate="header">
            <tr>
                <th pSortableColumn="symbol" style="min-width: 120px">
                    Symbol
                    <p-sortIcon field="symbol"></p-sortIcon>
                </th>
                <th pSortableColumn="lastPrice" style="min-width: 100px" class="text-right">
                    Last Price
                    <p-sortIcon field="lastPrice"></p-sortIcon>
                </th>
                <th pSortableColumn="priceChange" style="min-width: 100px" class="text-right">
                    Change
                    <p-sortIcon field="priceChange"></p-sortIcon>
                </th>
                <th pSortableColumn="percentChange" style="min-width: 100px" class="text-right">
                    Change %
                    <p-sortIcon field="percentChange"></p-sortIcon>
                </th>
            </tr>
        </ng-template>

        <ng-template pTemplate="body" let-stock>
            <tr class="stock-row cursor-pointer" 
                [class.selected-stock]="stock.symbol === selectedStockSymbol"
                (click)="onRowClick(stock)"
                (dblclick)="onRowDoubleClick(stock)">
                <td>
                    <span class="stock-symbol" title="Click to view chart">{{ stock.symbol }}</span>
                </td>
                <td class="text-right">
                    <span>₹{{ stock.lastPrice | number:'1.2-2' }}</span>
                </td>
                <td class="text-right">
                    <span [ngClass]="{
                      'text-green-500': stock.priceChange >= 0,
                      'text-red-500': stock.priceChange < 0
                    }">
                      {{ stock.priceChange >= 0 ? '+' : '' }}₹{{ stock.priceChange | number:'1.2-2' }}
                    </span>
                </td>
                <td class="text-right">
                    <span [ngClass]="{
                      'text-green-500': stock.percentChange >= 0,
                      'text-red-500': stock.percentChange < 0
                    }">
                      {{ stock.percentChange >= 0 ? '+' : '' }}{{ stock.percentChange | number:'1.2-2' }}%
                    </span>
                </td>
            </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
            <tr>
                <td colspan="9" class="text-center p-4">
                    <div class="flex flex-column align-items-center gap-3">
                        <i class="pi pi-filter-slash text-4xl text-400"></i>
                        <span class="text-lg text-600">No instruments match the selected filters</span>
                        <p class="text-sm text-500 mt-2">Try adjusting your filter criteria</p>
                    </div>
                </td>
            </tr>
        </ng-template>
</p-table>

<!-- Tooltip Template -->
<ng-template #stockTooltipTemplate>
    <div class="stock-tooltip-content">
        <div class="tooltip-header" *ngIf="hoveredStock?.companyName">
            {{hoveredStock?.companyName}}
        </div>
        
        <div class="tooltip-industry-sector" *ngIf="hoveredStock?.industry || hoveredStock?.sector">
            <span class="industry" *ngIf="hoveredStock?.industry">Industry: <strong>{{hoveredStock?.industry}}</strong></span>
            <span class="sector" *ngIf="hoveredStock?.sector">Sector: <strong>{{hoveredStock?.sector}}</strong></span>
        </div>
        
        <div class="tooltip-separator" *ngIf="(hoveredStock?.industry || hoveredStock?.sector) && hasNumericalData(hoveredStock)"></div>
        
        <div class="tooltip-data-section" *ngIf="hasNumericalData(hoveredStock)">
            <!-- Row 1: Open and Previous Close -->
            <div class="tooltip-data-row" *ngIf="hoveredStock?.openPrice || hoveredStock?.previousClose">
                <div class="data-item" *ngIf="hoveredStock?.openPrice">
                    <span class="label">Open:</span>
                    <span class="value">₹{{hoveredStock?.openPrice | number:'1.2-2'}}</span>
                </div>
                <div class="data-item" *ngIf="hoveredStock?.previousClose">
                    <span class="label">Prev Close:</span>
                    <span class="value">₹{{hoveredStock?.previousClose | number:'1.2-2'}}</span>
                </div>
            </div>
            
            <!-- Row 2: Day High and Day Low -->
            <div class="tooltip-data-row" *ngIf="hoveredStock?.dayHigh || hoveredStock?.dayLow">
                <div class="data-item" *ngIf="hoveredStock?.dayHigh">
                    <span class="label">Day High:</span>
                    <span class="value">₹{{hoveredStock?.dayHigh | number:'1.2-2'}}</span>
                </div>
                <div class="data-item" *ngIf="hoveredStock?.dayLow">
                    <span class="label">Day Low:</span>
                    <span class="value">₹{{hoveredStock?.dayLow | number:'1.2-2'}}</span>
                </div>
            </div>
            
            <!-- Row 3: Volume -->
            <div class="tooltip-data-row single-item" *ngIf="hoveredStock?.volume">
                <div class="data-item">
                    <span class="label">Volume:</span>
                    <span class="value">{{hoveredStock?.volume | number}}</span>
                </div>
            </div>
        </div>
    </div>
</ng-template>