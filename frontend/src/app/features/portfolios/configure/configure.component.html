<div class="configure-tab-content">
  @if (editingPortfolio) {
    <!-- Configuration Form -->
    <div class="configure-form">
      <!-- Name and Description Row -->
      <div class="form-row">
        <div class="form-field">
          <label for="portfolioName">Name</label>
          <input pInputText 
                 id="portfolioName"
                 [(ngModel)]="editingPortfolio.name"
                 placeholder="TestPortfolio"
                 [disabled]="!isEditing || isSaving" />
        </div>
        <div class="form-field">
          <label for="portfolioDescription">Description</label>
          <input pInputText 
                 id="portfolioDescription"
                 [(ngModel)]="editingPortfolio.description"
                 placeholder="Test"
                 [disabled]="!isEditing || isSaving" />
        </div>
      </div>

      <!-- Base Currency and Risk Profile Row -->
      <div class="form-row">
        <div class="form-field">
          <label for="baseCurrency">Base Currency</label>
          <p-select id="baseCurrency"
                   [options]="currencyOptions" 
                   [(ngModel)]="editingPortfolio.baseCurrency"
                   optionLabel="label"
                   optionValue="value"
                   placeholder="Select currency"
                   [disabled]="!isEditing || isSaving">
          </p-select>
        </div>
        <div class="form-field">
          <label for="riskProfile">Risk Profile</label>
          <p-select id="riskProfile"
                   [options]="riskProfileOptions" 
                   [(ngModel)]="editingPortfolio.riskProfile"
                   optionLabel="label"
                   optionValue="value"
                   placeholder="Select risk profile"
                   [disabled]="!isEditing || isSaving">
          </p-select>
        </div>
      </div>

      <!-- Initial Capital and Current Cash Row -->
      <div class="form-row">
        <div class="form-field">
          <label for="initialCapital">Initial Capital</label>
          <input pInputText 
                 id="initialCapital"
                 type="number"
                 [(ngModel)]="editingPortfolio.initialCapital"
                 placeholder="100000"
                 [disabled]="!isEditing || isSaving" />
        </div>
        <div class="form-field">
          <label for="currentCash">Current Cash</label>
          <input pInputText 
                 id="currentCash"
                 type="number"
                 [(ngModel)]="editingPortfolio.currentCash"
                 placeholder="15000"
                 [disabled]="!isEditing || isSaving" />
        </div>
      </div>

      <!-- Strategy Name and Trading Mode Row -->
      <div class="form-row">
        <div class="form-field">
          <label for="strategyName">Strategy Name</label>
          <p-select id="strategyName"
                   [options]="strategyOptions" 
                   [(ngModel)]="editingPortfolio.strategyName"
                   optionLabel="label"
                   optionValue="value"
                   placeholder="Select strategy"
                   [disabled]="!isEditing || isSaving">
          </p-select>
        </div>
        <div class="form-field">
          <label for="tradingMode">Trading Mode</label>
          <p-select id="tradingMode"
                   [options]="tradingModeOptions" 
                   [(ngModel)]="editingPortfolio.tradingMode"
                   optionLabel="label"
                   optionValue="value"
                   placeholder="Select mode"
                   [disabled]="!isEditing || isSaving">
          </p-select>
        </div>
      </div>

      <!-- Demat Account and Is Active Row -->
      <div class="form-row">
        <div class="form-field">
          <label for="dematAccount">Demat Account</label>
          <p-select id="dematAccount"
                   [options]="dematAccountOptions" 
                   [(ngModel)]="editingPortfolio.dematAccount"
                   optionLabel="label"
                   optionValue="value"
                   placeholder="Select account"
                   [disabled]="!isEditing || isSaving">
          </p-select>
        </div>
        <div class="form-field toggle-field">
          <label for="isActive">Is Active</label>
          <p-toggleSwitch id="isActive"
                         [(ngModel)]="editingPortfolio.isActive"
                         [disabled]="!isEditing || isSaving">
          </p-toggleSwitch>
        </div>
      </div>

      <!-- Portfolio Information Section -->
      <div class="portfolio-info-section">
        <h3>Portfolio Information</h3>
        <div class="info-row">
          <div class="info-item">
            <span class="info-label">Last Signal Check</span>
            <span class="info-value">{{ editingPortfolio.lastSignalCheck || '-' }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Created At</span>
            <span class="info-value">{{ editingPortfolio.createdAt || '-' }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Updated At</span>
            <span class="info-value">{{ editingPortfolio.updatedAt || '-' }}</span>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="form-actions">
        <button pButton 
                label="Reset" 
                class="p-button-outlined"
                (click)="cancelEdit()"
                [disabled]="isSaving">
        </button>
        <button pButton 
                label="Save Configuration" 
                class="p-button-success"
                (click)="saveEditAll()"
                [disabled]="isSaving">
          @if (isSaving) {
            <i class="pi pi-spin pi-spinner"></i>
          }
        </button>
      </div>
    </div>

    <!-- Portfolio Holdings Table -->
    <div class="holdings-section">
      <div class="holdings-header">
        <h3>Portfolio Holdings</h3>
        @if (isLoadingHoldings) {
          <div class="loading-indicator">
            <i class="pi pi-spin pi-spinner"></i>
            Loading holdings...
          </div>
        }
      </div>

      @if (portfolioHoldings.length > 0) {
        <div class="holdings-table-container">
          <!-- Global Filter and Actions Row -->
          <div class="table-filter-row">
            <span class="p-input-icon-left">
              <i class="pi pi-search"></i>
              <input pInputText 
                     type="text" 
                     [(ngModel)]="globalFilterValue" 
                     (input)="onGlobalFilterChange($event)"
                     placeholder="Search holdings..." 
                     class="p-inputtext-sm" />
            </span>
            
            <div class="table-actions">
              <button pButton 
                      icon="pi pi-refresh" 
                      class="p-button-outlined p-button-sm"
                      (click)="refreshHoldings()"
                      title="Refresh holdings">
              </button>
              
              <button pButton 
                      label="Add Stock" 
                      icon="pi pi-plus" 
                      class="p-button-sm"
                      (click)="openAddStockDialog()"
                      title="Add stock to portfolio">
              </button>
            </div>
          </div>

          <p-table [value]="portfolioHoldings" 
                   styleClass="p-datatable-sm holdings-table"
                   [tableStyle]="{'min-width': '100%'}"
                   [scrollable]="true"
                   scrollHeight="400px"
                   [sortMode]="'multiple'"
                   [globalFilterFields]="['symbol']"
                   [showCurrentPageReport]="true"
                   currentPageReportTemplate="Showing {first} to {last} of {totalRecords} holdings"
                   [rowsPerPageOptions]="[5, 10, 25]"
                   [paginator]="true"
                   [rows]="10">
            
            <ng-template pTemplate="header">
              <tr>
                <th style="width: 25%">Stock</th>
                <th style="width: 20%">LTP</th>
                <th style="width: 15%">Sector</th>
                <th style="width: 15%">Industry</th>
                <th style="width: 10%">Volume</th>
                <th style="width: 10%">VWAP</th>
                <th style="width: 5%">Actions</th>
              </tr>
            </ng-template>

            <ng-template pTemplate="body" let-holding>
              <tr>
                <!-- Stock Column -->
                <td>
                  <div class="stock-info">
                    <div class="stock-symbol">{{ holding.symbol }}</div>
                    <div class="stock-name">{{ getMarketData(holding.symbol).name || holding.symbol + ' Limited' }}</div>
                  </div>
                </td>

                <!-- LTP Column -->
                <td>
                  <div class="ltp-info">
                    <div class="current-price">₹{{ (getMarketData(holding.symbol).currentPrice || 0) | number:'1.2-2' }}</div>
                    <div class="price-change" 
                         [ngClass]="(getMarketData(holding.symbol).change || 0) >= 0 ? 'positive' : 'negative'">
                      <i class="pi" 
                         [ngClass]="(getMarketData(holding.symbol).change || 0) >= 0 ? 'pi-arrow-up' : 'pi-arrow-down'">
                      </i>
                      {{ (getMarketData(holding.symbol).change || 0) >= 0 ? '+' : '' }}{{ (getMarketData(holding.symbol).changePercent || 0) | number:'1.2-2' }}%
                    </div>
                  </div>
                </td>

                <!-- Sector Column -->
                <td>
                  <span class="sector-tag">{{ getMarketData(holding.symbol).sector || 'Unknown' }}</span>
                </td>

                <!-- Industry Column -->
                <td>
                  <span class="industry-tag">{{ getMarketData(holding.symbol).industry || 'Unknown' }}</span>
                </td>

                <!-- Volume Column -->
                <td>
                  <div class="volume-info">
                    {{ (getMarketData(holding.symbol).volume || 0) | number:'1.0-0' }}
                  </div>
                </td>

                <!-- VWAP Column -->
                <td>
                  <div class="vwap-info">
                    ₹{{ (getMarketData(holding.symbol).vwap || 0) | number:'1.2-2' }}
                  </div>
                </td>

                <!-- Actions Column -->
                <td>
                  <button class="action-btn delete-btn" 
                          title="Remove holding"
                          (click)="removeHolding(holding)">
                    <i class="pi pi-trash"></i>
                  </button>
                </td>
              </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
              <tr>
                <td colspan="7" class="text-center">
                  <div class="empty-holdings">
                    <i class="pi pi-info-circle"></i>
                    <p>No holdings found for this portfolio.</p>
                    <p>Add stocks to start building your portfolio.</p>
                  </div>
                </td>
              </tr>
            </ng-template>
          </p-table>
        </div>
      } @else if (!isLoadingHoldings) {
        <div class="no-holdings-message">
          <i class="pi pi-info-circle"></i>
          <h4>No Holdings</h4>
          <p>This portfolio doesn't have any holdings yet.</p>
          <button pButton 
                  label="Add Holdings" 
                  icon="pi pi-plus" 
                  class="p-button-outlined p-button-sm"
                  (click)="addHoldings()">
          </button>
        </div>
      }
    </div>
  } @else {
    <div class="no-selection-message">
      <i class="pi pi-info-circle"></i>
      <h3>No Portfolio Selected</h3>
      <p>Please select a portfolio from the Overview tab to configure it, or click "Create Portfolio" to create a new one.</p>
      <button pButton 
              label="Back to Overview" 
              icon="pi pi-arrow-left" 
              class="p-button-outlined"
              (click)="navigateToOverview()">
      </button>
    </div>
  }

  <!-- Add Stock Dialog -->
  <p-dialog header="Add Stock to Portfolio" 
            [(visible)]="showAddStockDialog" 
            [modal]="true" 
            [closable]="true"
            [draggable]="false"
            [resizable]="false"
            styleClass="add-stock-dialog"
            [style]="{width: '500px', height: '620px'}">
    
    <div class="add-stock-content">
      <!-- Stock Search -->
      <div class="stock-search-section">
        <label for="stockSearch" class="field-label">Search Stock</label>
        <div class="stock-search-input-container">
          <span class="p-input-icon-left">
            <i class="pi pi-search"></i>
            <input pInputText 
                   id="stockSearch"
                   type="text" 
                   [(ngModel)]="stockSearchQuery"
                   (input)="onStockSearchInput($event)"
                   placeholder="Type stock symbol or name..."
                   class="stock-search-input" />
          </span>
          @if (isSearchingStocks) {
            <div class="search-loading">
              <i class="pi pi-spin pi-spinner"></i>
            </div>
          }
        </div>
        
        <!-- Search Results -->
        @if (stockSearchResults.length > 0) {
          <div class="search-results">
            @for (stock of stockSearchResults; track stock.symbol) {
              <div class="search-result-item" 
                   (click)="selectStock(stock)"
                   [class.selected]="selectedStock?.symbol === stock.symbol">
                <div class="stock-info">
                  <div class="stock-symbol">{{ stock.symbol }}</div>
                  <div class="stock-name">{{ stock.name }}</div>
                </div>
                <div class="stock-price" *ngIf="stock.price && stock.price > 0">
                  ₹{{ stock.price | number:'1.2-2' }}
                </div>
              </div>
            }
          </div>
        } @else if (stockSearchQuery && stockSearchQuery.length >= 2 && !isSearchingStocks && !selectedStock) {
          <div class="no-results">
            <i class="pi pi-info-circle"></i>
            <span>No stocks found. Try a different search term.</span>
          </div>
        }
      </div>

      <!-- Selected Stock Info -->
      <div class="selected-stock-section" *ngIf="selectedStock">
        <h4>Selected Stock</h4>
        
        @if (isLoadingStockDetails) {
          <div class="loading-stock-details">
            <i class="pi pi-spin pi-spinner"></i>
            <span>Loading stock details...</span>
          </div>
        } @else if (selectedStockDetails) {
          <div class="selected-stock-info">
            <!-- Basic Stock Info - Company Name with Industry -->
            <div class="stock-basic-info">
              <div class="stock-symbol">{{ selectedStockDetails.symbol || selectedStock.symbol }}</div>
              <div class="stock-name-with-industry">
                {{ selectedStockDetails.name || selectedStock.name || selectedStock.companyName || (selectedStock.symbol + ' Limited') }}
                <span *ngIf="selectedStockDetails.industry"> - {{ selectedStockDetails.industry }}</span>
              </div>
            </div>
            
            <!-- Organized Market Data Rows -->
            <div class="stock-market-data">
              <!-- Open, Close Row -->
              <div class="market-data-row">
                <div class="market-item">
                  <span class="market-label">Open:</span>
                  <span class="market-value">₹{{ (selectedStockDetails.open || 0) | number:'1.2-2' }}</span>
                </div>
                <div class="market-item">
                  <span class="market-label">Close:</span>
                  <span class="market-value">₹{{ (selectedStockDetails.previousClose || 0) | number:'1.2-2' }}</span>
                </div>
              </div>
              
              <!-- High, Low Row -->
              <div class="market-data-row">
                <div class="market-item">
                  <span class="market-label">High:</span>
                  <span class="market-value">₹{{ (selectedStockDetails.dayHigh || 0) | number:'1.2-2' }}</span>
                </div>
                <div class="market-item">
                  <span class="market-label">Low:</span>
                  <span class="market-value">₹{{ (selectedStockDetails.dayLow || 0) | number:'1.2-2' }}</span>
                </div>
              </div>
              
              <!-- Change, Change % Row -->
              <div class="market-data-row">
                <div class="market-item">
                  <span class="market-label">Change:</span>
                  <span class="market-value">{{ (selectedStockDetails.change || 0) >= 0 ? '+' : '' }}₹{{ (selectedStockDetails.change || 0) | number:'1.2-2' }}</span>
                </div>
                <div class="market-item">
                  <span class="market-label">Change %:</span>
                  <span class="market-value">{{ (selectedStockDetails.changePercent || 0) >= 0 ? '+' : '' }}{{ (selectedStockDetails.changePercent || 0) | number:'1.2-2' }}%</span>
                </div>
              </div>
              
              <!-- Volume, VWAP Row -->
              <div class="market-data-row">
                <div class="market-item">
                  <span class="market-label">Volume:</span>
                  <span class="market-value">{{ (selectedStockDetails.volume || 0) | number:'1.0-0' }}</span>
                </div>
                <div class="market-item">
                  <span class="market-label">VWAP:</span>
                  <span class="market-value">₹{{ (selectedStockDetails.vwap || 0) | number:'1.2-2' }}</span>
                </div>
              </div>
            </div>
          </div>
        } @else {
          <!-- Fallback to basic info if details failed to load -->
          <div class="selected-stock-info">
            <div class="stock-basic-info">
              <div class="stock-symbol">{{ selectedStock.symbol }}</div>
              <div class="stock-name">{{ selectedStock.name || selectedStock.companyName }}</div>
            </div>
          </div>
        }
      </div>

      <!-- Quantity Input -->
      <div class="quantity-section" *ngIf="selectedStock">
        <label for="stockQuantity" class="field-label">Quantity</label>
        <input pInputText 
               id="stockQuantity"
               type="number" 
               [(ngModel)]="stockQuantity"
               placeholder="Enter quantity"
               min="0"
               class="quantity-input" />
        <small class="field-help">Default quantity is 0. You can modify this later.</small>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <div class="dialog-footer">
        <button pButton 
                label="Cancel" 
                icon="pi pi-times" 
                class="p-button-outlined"
                (click)="closeAddStockDialog()"
                [disabled]="isAddingStock">
        </button>
        <button pButton 
                label="Add Stock" 
                icon="pi pi-plus" 
                class="p-button"
                (click)="addSelectedStock()"
                [disabled]="!selectedStock || isAddingStock">
          @if (isAddingStock) {
            <i class="pi pi-spin pi-spinner"></i>
            Adding...
          }
        </button>
      </div>
    </ng-template>
  </p-dialog>
</div>
