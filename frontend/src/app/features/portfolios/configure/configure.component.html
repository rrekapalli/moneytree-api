<div class="configure-tab-content">
  @if (selectedPortfolio) {
    @if (isLoading) {
      <!-- Loading State -->
      <div class="loading-message">
        <i class="pi pi-spin pi-spinner"></i>
        <p>Loading configuration...</p>
      </div>
    } @else if (errorMessage) {
      <!-- Error State -->
      <div class="error-message">
        <i class="pi pi-exclamation-triangle"></i>
        <h3>Error Loading Configuration</h3>
        <p>{{ errorMessage }}</p>
        <button pButton 
                label="Retry" 
                icon="pi pi-refresh" 
                class="p-button-outlined"
                (click)="loadConfig(selectedPortfolio.id)">
        </button>
      </div>
    } @else if (portfolioConfig) {
      <!-- Configuration Form -->
      <div class="configure-form">
        <h2 class="form-title">Portfolio Configuration</h2>
        
        <!-- Trading Configuration Section -->
        <div class="config-section">
          <h3 class="section-title">Trading Configuration</h3>
          <div class="form-row">
            <div class="form-field">
              <label for="tradingMode">Trading Mode <span class="required">*</span></label>
              <input pInputText 
                     id="tradingMode"
                     [(ngModel)]="portfolioConfig.tradingMode"
                     (ngModelChange)="onFormChange()"
                     placeholder="paper"
                     [disabled]="isSaving"
                     [class.invalid]="hasValidationError('tradingMode')" />
              @if (hasValidationError('tradingMode')) {
                <small class="validation-error">{{ getValidationError('tradingMode') }}</small>
              }
            </div>
            <div class="form-field">
              <label for="signalCheckInterval">Signal Check Interval (seconds) <span class="required">*</span></label>
              <input pInputText 
                     id="signalCheckInterval"
                     type="number"
                     [(ngModel)]="portfolioConfig.signalCheckInterval"
                     (ngModelChange)="onFormChange()"
                     placeholder="300"
                     [disabled]="isSaving"
                     [class.invalid]="hasValidationError('signalCheckInterval')" />
              @if (hasValidationError('signalCheckInterval')) {
                <small class="validation-error">{{ getValidationError('signalCheckInterval') }}</small>
              }
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label for="lookbackDays">Lookback Days <span class="required">*</span></label>
              <input pInputText 
                     id="lookbackDays"
                     type="number"
                     [(ngModel)]="portfolioConfig.lookbackDays"
                     (ngModelChange)="onFormChange()"
                     placeholder="30"
                     [disabled]="isSaving"
                     [class.invalid]="hasValidationError('lookbackDays')" />
              @if (hasValidationError('lookbackDays')) {
                <small class="validation-error">{{ getValidationError('lookbackDays') }}</small>
              }
            </div>
            <div class="form-field toggle-field">
              <label for="enableConditionalLogging">Enable Conditional Logging</label>
              <p-toggleswitch 
                id="enableConditionalLogging"
                [(ngModel)]="portfolioConfig.enableConditionalLogging"
                (ngModelChange)="onFormChange()"
                [disabled]="isSaving">
              </p-toggleswitch>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label for="cacheDurationSeconds">Cache Duration (seconds)</label>
              <input pInputText 
                     id="cacheDurationSeconds"
                     type="number"
                     [(ngModel)]="portfolioConfig.cacheDurationSeconds"
                     (ngModelChange)="onFormChange()"
                     placeholder="300"
                     [disabled]="isSaving" />
            </div>
            <div class="form-field">
              <label for="exchange">Exchange</label>
              <input pInputText 
                     id="exchange"
                     [(ngModel)]="portfolioConfig.exchange"
                     (ngModelChange)="onFormChange()"
                     placeholder="NSE"
                     [disabled]="isSaving" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label for="candleInterval">Candle Interval</label>
              <input pInputText 
                     id="candleInterval"
                     [(ngModel)]="portfolioConfig.candleInterval"
                     (ngModelChange)="onFormChange()"
                     placeholder="day"
                     [disabled]="isSaving" />
            </div>
          </div>
        </div>

        <!-- Historical Cache Configuration Section -->
        <div class="config-section">
          <h3 class="section-title">Historical Cache Configuration</h3>
          <div class="form-row">
            <div class="form-field toggle-field">
              <label for="historicalCacheEnabled">Enable Historical Cache</label>
              <p-toggleswitch 
                id="historicalCacheEnabled"
                [(ngModel)]="portfolioConfig.historicalCacheEnabled"
                (ngModelChange)="onFormChange()"
                [disabled]="isSaving">
              </p-toggleswitch>
            </div>
            <div class="form-field">
              <label for="historicalCacheLookbackDays">Lookback Days</label>
              <input pInputText 
                     id="historicalCacheLookbackDays"
                     type="number"
                     [(ngModel)]="portfolioConfig.historicalCacheLookbackDays"
                     (ngModelChange)="onFormChange()"
                     placeholder="365"
                     [disabled]="isSaving" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label for="historicalCacheExchange">Exchange</label>
              <input pInputText 
                     id="historicalCacheExchange"
                     [(ngModel)]="portfolioConfig.historicalCacheExchange"
                     (ngModelChange)="onFormChange()"
                     placeholder="NSE"
                     [disabled]="isSaving" />
            </div>
            <div class="form-field">
              <label for="historicalCacheInstrumentType">Instrument Type</label>
              <input pInputText 
                     id="historicalCacheInstrumentType"
                     [(ngModel)]="portfolioConfig.historicalCacheInstrumentType"
                     (ngModelChange)="onFormChange()"
                     placeholder="EQ"
                     [disabled]="isSaving" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label for="historicalCacheCandleInterval">Candle Interval</label>
              <input pInputText 
                     id="historicalCacheCandleInterval"
                     [(ngModel)]="portfolioConfig.historicalCacheCandleInterval"
                     (ngModelChange)="onFormChange()"
                     placeholder="day"
                     [disabled]="isSaving" />
            </div>
            <div class="form-field">
              <label for="historicalCacheTtlSeconds">TTL (seconds)</label>
              <input pInputText 
                     id="historicalCacheTtlSeconds"
                     type="number"
                     [(ngModel)]="portfolioConfig.historicalCacheTtlSeconds"
                     (ngModelChange)="onFormChange()"
                     placeholder="86400"
                     [disabled]="isSaving" />
            </div>
          </div>
        </div>

        <!-- Redis Configuration Section -->
        <div class="config-section">
          <h3 class="section-title">Redis Configuration</h3>
          <div class="form-row">
            <div class="form-field toggle-field">
              <label for="redisEnabled">Enable Redis</label>
              <p-toggleswitch 
                id="redisEnabled"
                [(ngModel)]="portfolioConfig.redisEnabled"
                (ngModelChange)="onFormChange()"
                [disabled]="isSaving">
              </p-toggleswitch>
            </div>
            <div class="form-field">
              <label for="redisHost">Host @if (portfolioConfig.redisEnabled) {<span class="required">*</span>}</label>
              <input pInputText 
                     id="redisHost"
                     [(ngModel)]="portfolioConfig.redisHost"
                     (ngModelChange)="onFormChange()"
                     placeholder="localhost"
                     [disabled]="isSaving"
                     [class.invalid]="hasValidationError('redisHost')" />
              @if (hasValidationError('redisHost')) {
                <small class="validation-error">{{ getValidationError('redisHost') }}</small>
              }
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label for="redisPort">Port @if (portfolioConfig.redisEnabled) {<span class="required">*</span>}</label>
              <input pInputText 
                     id="redisPort"
                     type="number"
                     [(ngModel)]="portfolioConfig.redisPort"
                     (ngModelChange)="onFormChange()"
                     placeholder="6379"
                     [disabled]="isSaving"
                     [class.invalid]="hasValidationError('redisPort')" />
              @if (hasValidationError('redisPort')) {
                <small class="validation-error">{{ getValidationError('redisPort') }}</small>
              }
            </div>
            <div class="form-field">
              <label for="redisPassword">Password</label>
              <input pInputText 
                     id="redisPassword"
                     type="password"
                     [(ngModel)]="portfolioConfig.redisPassword"
                     (ngModelChange)="onFormChange()"
                     placeholder="Optional"
                     [disabled]="isSaving" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label for="redisDb">Database</label>
              <input pInputText 
                     id="redisDb"
                     type="number"
                     [(ngModel)]="portfolioConfig.redisDb"
                     (ngModelChange)="onFormChange()"
                     placeholder="0"
                     [disabled]="isSaving" />
            </div>
            <div class="form-field">
              <label for="redisKeyPrefix">Key Prefix</label>
              <input pInputText 
                     id="redisKeyPrefix"
                     [(ngModel)]="portfolioConfig.redisKeyPrefix"
                     (ngModelChange)="onFormChange()"
                     placeholder="portfolio:"
                     [disabled]="isSaving" />
            </div>
          </div>
        </div>

        <!-- Entry Conditions Section -->
        <div class="config-section">
          <h3 class="section-title">Entry Conditions</h3>
          <div class="form-row">
            <div class="form-field toggle-field">
              <label for="entryBbLower">BB Lower</label>
              <p-toggleswitch 
                id="entryBbLower"
                [(ngModel)]="portfolioConfig.entryBbLower"
                (ngModelChange)="onFormChange()"
                [disabled]="isSaving">
              </p-toggleswitch>
            </div>
            <div class="form-field">
              <label for="entryRsiThreshold">RSI Threshold (0-100)</label>
              <input pInputText 
                     id="entryRsiThreshold"
                     type="number"
                     [(ngModel)]="portfolioConfig.entryRsiThreshold"
                     (ngModelChange)="onFormChange()"
                     placeholder="30"
                     [disabled]="isSaving"
                     [class.invalid]="hasValidationError('entryRsiThreshold')" />
              @if (hasValidationError('entryRsiThreshold')) {
                <small class="validation-error">{{ getValidationError('entryRsiThreshold') }}</small>
              }
            </div>
          </div>
          <div class="form-row">
            <div class="form-field toggle-field">
              <label for="entryMacdTurnPositive">MACD Turn Positive</label>
              <p-toggleswitch 
                id="entryMacdTurnPositive"
                [(ngModel)]="portfolioConfig.entryMacdTurnPositive"
                (ngModelChange)="onFormChange()"
                [disabled]="isSaving">
              </p-toggleswitch>
            </div>
            <div class="form-field toggle-field">
              <label for="entryVolumeAboveAvg">Volume Above Average</label>
              <p-toggleswitch 
                id="entryVolumeAboveAvg"
                [(ngModel)]="portfolioConfig.entryVolumeAboveAvg"
                (ngModelChange)="onFormChange()"
                [disabled]="isSaving">
              </p-toggleswitch>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label for="entryFallbackSmaPeriod">Fallback SMA Period</label>
              <input pInputText 
                     id="entryFallbackSmaPeriod"
                     type="number"
                     [(ngModel)]="portfolioConfig.entryFallbackSmaPeriod"
                     (ngModelChange)="onFormChange()"
                     placeholder="20"
                     [disabled]="isSaving" />
            </div>
            <div class="form-field">
              <label for="entryFallbackAtrMultiplier">Fallback ATR Multiplier</label>
              <input pInputText 
                     id="entryFallbackAtrMultiplier"
                     type="number"
                     step="0.1"
                     [(ngModel)]="portfolioConfig.entryFallbackAtrMultiplier"
                     (ngModelChange)="onFormChange()"
                     placeholder="2.0"
                     [disabled]="isSaving" />
            </div>
          </div>
        </div>

        <!-- Exit Conditions Section -->
        <div class="config-section">
          <h3 class="section-title">Exit Conditions</h3>
          <div class="form-row">
            <div class="form-field">
              <label for="exitTakeProfitPct">Take Profit (%)</label>
              <input pInputText 
                     id="exitTakeProfitPct"
                     type="number"
                     step="0.1"
                     [(ngModel)]="portfolioConfig.exitTakeProfitPct"
                     (ngModelChange)="onFormChange()"
                     placeholder="5.0"
                     [disabled]="isSaving" />
            </div>
            <div class="form-field">
              <label for="exitStopLossAtrMult">Stop Loss ATR Multiplier</label>
              <input pInputText 
                     id="exitStopLossAtrMult"
                     type="number"
                     step="0.1"
                     [(ngModel)]="portfolioConfig.exitStopLossAtrMult"
                     (ngModelChange)="onFormChange()"
                     placeholder="2.0"
                     [disabled]="isSaving" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-field toggle-field">
              <label for="exitAllowTpExitsOnly">Allow TP Exits Only</label>
              <p-toggleswitch 
                id="exitAllowTpExitsOnly"
                [(ngModel)]="portfolioConfig.exitAllowTpExitsOnly"
                (ngModelChange)="onFormChange()"
                [disabled]="isSaving">
              </p-toggleswitch>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="form-actions">
          <button pButton 
                  label="Reset" 
                  class="p-button-outlined"
                  (click)="cancelEdit()"
                  [disabled]="!isFormDirty || isSaving">
          </button>
          <button pButton 
                  label="Save Configuration" 
                  class="p-button-success"
                  (click)="saveConfiguration()"
                  [disabled]="!isFormDirty || isSaving || !isFormValid()">
            @if (isSaving) {
              <i class="pi pi-spin pi-spinner"></i>
            }
          </button>
        </div>

        <!-- Config Status Info -->
        <div class="config-info">
          <p><strong>Status:</strong> {{ configExists ? 'Existing Configuration' : 'New Configuration (will be created on save)' }}</p>
        </div>
      </div>
    }
  } @else {
    <div class="no-selection-message">
      <i class="pi pi-info-circle"></i>
      <h3>No Portfolio Selected</h3>
      <p>Please select a portfolio from the Overview tab to configure it.</p>
      <button pButton 
              label="Back to Overview" 
              icon="pi pi-arrow-left" 
              class="p-button-outlined"
              (click)="navigateToOverview()">
      </button>
    </div>
  }
</div>
