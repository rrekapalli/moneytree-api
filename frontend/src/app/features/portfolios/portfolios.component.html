<!-- Page Header -->
<app-page-header
  title="Portfolios"
  subtitle="Configure and manage your investment portfolios"
  actionButtonLabel="Create Portfolio"
  actionButtonIcon="pi pi-plus"
  (actionButtonClick)="createPortfolio()">
</app-page-header>

<div class="page-container">

  <!-- Summary Cards Section -->
  <div class="summary-cards" role="region" aria-label="Portfolio summary statistics">
    <div class="summary-card" role="article" aria-label="Total portfolios count">
      <div class="card-content">
        <div class="card-value" aria-live="polite">{{ totalPortfolios }}</div>
        <div class="card-label">Total Portfolios</div>
      </div>
      <div class="card-icon" aria-hidden="true">
        <i class="pi pi-chart-line"></i>
      </div>
    </div>

    <div class="summary-card" role="article" aria-label="Active portfolios count">
      <div class="card-content">
        <div class="card-value" aria-live="polite">{{ activePortfolios }}</div>
        <div class="card-label">Active Portfolios</div>
      </div>
      <div class="card-icon" aria-hidden="true">
        <i class="pi pi-check-circle"></i>
      </div>
    </div>

    <div class="summary-card" role="article" aria-label="Conservative portfolios count">
      <div class="card-content">
        <div class="card-value" aria-live="polite">{{ conservativePortfolios }}</div>
        <div class="card-label">Conservative</div>
      </div>
      <div class="card-icon" aria-hidden="true">
        <i class="pi pi-shield"></i>
      </div>
    </div>

    <div class="summary-card" role="article" aria-label="Moderate portfolios count">
      <div class="card-content">
        <div class="card-value" aria-live="polite">{{ moderatePortfolios }}</div>
        <div class="card-label">Moderate</div>
      </div>
      <div class="card-icon" aria-hidden="true">
        <i class="pi pi-balance-scale"></i>
      </div>
    </div>

    <div class="summary-card" role="article" aria-label="Aggressive portfolios count">
      <div class="card-content">
        <div class="card-value" aria-live="polite">{{ aggressivePortfolios }}</div>
        <div class="card-label">Aggressive</div>
      </div>
      <div class="card-icon" aria-hidden="true">
        <i class="pi pi-rocket"></i>
      </div>
    </div>
  </div>

  <!-- Two-Panel Layout -->
  <div class="two-panel-layout">
    <!-- Left Sidebar -->
    <div class="left-sidebar" role="navigation" aria-label="Portfolio list">
      <!-- Search Input -->
      <div class="search-section">
        <label for="portfolio-search" class="sr-only">Search portfolios</label>
        <div class="search-controls">
          <span class="p-input-icon-left search-input-wrapper">
            <i class="pi pi-search" aria-hidden="true"></i>
            <input 
              id="portfolio-search"
              type="text" 
              pInputText 
              [(ngModel)]="searchText" 
              (ngModelChange)="onSearchChange()"
              placeholder="Search..." 
              class="search-input"
              aria-label="Search portfolios by name or description" />
          </span>
          <p-select 
            [(ngModel)]="sortField"
            [options]="sortOptions"
            (ngModelChange)="onSortFieldChange()"
            optionLabel="label"
            optionValue="value"
            appendTo="body"
            class="sort-dropdown"
            [pTooltip]="getSortLabel()"
            tooltipPosition="top"
            aria-label="Sort portfolios">
            <ng-template pTemplate="selectedItem">
              <i class="pi pi-sort-alt"></i>
            </ng-template>
          </p-select>
        </div>
      </div>

      <!-- Portfolio List -->
      <p-scrollpanel *ngIf="!loading" class="portfolio-list-scroll" [style]="{ width: '100%', height: '100%' }">
        <div class="portfolio-list" role="list" aria-label="Available portfolios">
          <div 
            *ngFor="let portfolio of filteredPortfolios; trackBy: trackPortfolioById"
            class="portfolio-card"
            [class.selected]="selectedPortfolio?.id === portfolio.id"
            (click)="selectPortfolio(portfolio)"
            (keydown.enter)="selectPortfolio(portfolio)"
            (keydown.space)="selectPortfolio(portfolio); $event.preventDefault()"
            role="listitem"
            tabindex="0"
            [attr.aria-label]="'Portfolio: ' + portfolio.name + ', Return: ' + formatReturn(portfolio.totalReturn || 0) + ', ' + (portfolio.isActive ? 'Active' : 'Inactive')"
            [attr.aria-selected]="selectedPortfolio?.id === portfolio.id">
            
            <div class="portfolio-card-header">
              <h3 class="portfolio-name">{{ portfolio.name }}</h3>
              <p-tag 
                [value]="portfolio.isActive ? 'Active' : 'Inactive'" 
                [severity]="portfolio.isActive ? 'success' : 'secondary'"
                [attr.aria-label]="'Status: ' + (portfolio.isActive ? 'Active' : 'Inactive')">
              </p-tag>
            </div>

            <p class="portfolio-description">{{ portfolio.description }}</p>

            <div class="portfolio-metrics">
              <div class="metric">
                <span class="metric-label">Return</span>
                <span 
                  class="metric-value" 
                  [style.color]="getPerformanceColor(portfolio.totalReturn || 0)">
                  {{ formatReturn(portfolio.totalReturn || 0) }}
                </span>
              </div>
              <div class="metric">
                <span class="metric-label">Stocks</span>
                <span class="metric-value">{{ portfolio.stockCount || 0 }}</span>
              </div>
              <div class="metric">
                <span class="metric-label">Outperformance</span>
                <span 
                  class="metric-value" 
                  [style.color]="getPerformanceColor(portfolio.outperformance || 0)">
                  {{ formatReturn(portfolio.outperformance || 0) }}
                </span>
              </div>
            </div>

            <div class="portfolio-footer">
              <span class="last-executed">
                <i class="pi pi-clock"></i>
                Last: {{ portfolio.lastRebalance || 'N/A' }}
              </span>
              <span class="risk-profile">
                <i [class]="getPortfolioIcon(portfolio.riskProfile)"></i>
                {{ getRiskProfileLabel(portfolio.riskProfile) }}
              </span>
            </div>
          </div>

          <!-- Empty State -->
          <div *ngIf="filteredPortfolios.length === 0" class="empty-state" role="status" aria-live="polite">
            <i class="pi pi-inbox" aria-hidden="true"></i>
            <p>No portfolios found</p>
            <p-button 
              label="Clear Filters" 
              icon="pi pi-filter-slash" 
              (onClick)="clearFilters()"
              [text]="true"
              aria-label="Clear all filters to show all portfolios">
            </p-button>
          </div>
        </div>
      </p-scrollpanel>

      <!-- Loading State -->
      <div *ngIf="loading" class="loading-state" role="status" aria-live="polite" aria-busy="true">
        <i class="pi pi-spin pi-spinner" aria-hidden="true"></i>
        <p>Loading portfolios...</p>
        <p *ngIf="retryCount > 0" class="retry-info">Retrying... (Attempt {{ retryCount + 1 }} of {{ maxRetries + 1 }})</p>
      </div>

      <!-- Error State -->
      <div *ngIf="error" class="error-state" role="alert" aria-live="assertive">
        <i class="pi pi-exclamation-triangle" aria-hidden="true"></i>
        <p>{{ error }}</p>
        <p-button 
          label="Retry" 
          icon="pi pi-refresh" 
          (onClick)="loadPortfolios()"
          [text]="true"
          aria-label="Retry loading portfolios">
        </p-button>
      </div>
    </div>

    <!-- Right Detail Panel -->
    <div class="right-panel" role="main" aria-label="Portfolio details">
      <!-- Show message when no portfolio is selected -->
      <div *ngIf="!selectedPortfolio" class="no-selection-state" role="status">
        <i class="pi pi-chart-line" aria-hidden="true"></i>
        <h3>Select a Portfolio</h3>
        <p>Choose a portfolio from the list to view details and manage settings</p>
      </div>

      <!-- Show tabs when a portfolio is selected -->
      <div *ngIf="selectedPortfolio" class="portfolio-detail">
        <p-tabs [(value)]="activeTab" (valueChange)="onTabChange($event)" role="tablist" [attr.aria-label]="'Portfolio details for ' + selectedPortfolio.name">
          <p-tablist>
            <p-tab value="overview" role="tab" [attr.aria-selected]="activeTab === 'overview'" [attr.aria-controls]="'overview-panel'">
              <i class="pi pi-chart-line" aria-hidden="true"></i>
              Overview
            </p-tab>
            <p-tab value="details" role="tab" [attr.aria-selected]="activeTab === 'details'" [attr.aria-controls]="'details-panel'">
              <i class="pi pi-info-circle" aria-hidden="true"></i>
              Details
            </p-tab>
            <p-tab value="configure" role="tab" [attr.aria-selected]="activeTab === 'configure'" [attr.aria-controls]="'configure-panel'">
              <i class="pi pi-cog" aria-hidden="true"></i>
              Configure
            </p-tab>
            <p-tab value="holdings" role="tab" [attr.aria-selected]="activeTab === 'holdings'" [attr.aria-controls]="'holdings-panel'">
              <i class="pi pi-briefcase" aria-hidden="true"></i>
              Holdings
            </p-tab>
            <p-tab value="trades" role="tab" [attr.aria-selected]="activeTab === 'trades'" [attr.aria-controls]="'trades-panel'">
              <i class="pi pi-history" aria-hidden="true"></i>
              Trades
            </p-tab>
          </p-tablist>
          <p-tabpanels>
            <!-- Overview Tab -->
            <p-tabpanel value="overview" role="tabpanel" id="overview-panel" [attr.aria-labelledby]="'Overview tab for ' + selectedPortfolio.name">
              <div class="tab-content">
                <h3>Overview - {{ selectedPortfolio.name }}</h3>
                <p>Overview content will be implemented in future tasks</p>
              </div>
            </p-tabpanel>

            <!-- Details Tab -->
            <p-tabpanel value="details" role="tabpanel" id="details-panel" [attr.aria-labelledby]="'Details tab for ' + selectedPortfolio.name">
              <app-portfolio-details
                [selectedPortfolio]="selectedPortfolio"
                [riskProfileOptions]="riskProfileOptions"
                (saveChanges)="onDetailsSave($event)"
                (cancel)="onDetailsCancel()">
              </app-portfolio-details>
            </p-tabpanel>

            <!-- Configure Tab -->
            <p-tabpanel value="configure" role="tabpanel" id="configure-panel" [attr.aria-labelledby]="'Configure tab for ' + selectedPortfolio.name">
              <app-portfolio-configure
                [selectedPortfolio]="selectedPortfolio"
                [tradingModeOptions]="tradingModeOptions"
                [exchangeOptions]="exchangeOptions"
                [candleIntervalOptions]="candleIntervalOptions"
                [instrumentTypeOptions]="instrumentTypeOptions"
                (saveChanges)="onConfigSave($event)"
                (cancel)="onConfigureCancel()"
                (goToOverview)="onTabChange('overview')">
              </app-portfolio-configure>
            </p-tabpanel>

            <!-- Holdings Tab -->
            <p-tabpanel value="holdings" role="tabpanel" id="holdings-panel" [attr.aria-labelledby]="'Holdings tab for ' + selectedPortfolio.name">
              <app-portfolio-holdings
                [selectedPortfolio]="selectedPortfolio"
                [holdings]="holdings"
                [holdingsLoading]="holdingsLoading"
                [holdingsError]="holdingsError"
                (holdingUpdated)="onHoldingUpdated($event)">
              </app-portfolio-holdings>
            </p-tabpanel>

            <!-- Trades Tab -->
            <p-tabpanel value="trades" role="tabpanel" id="trades-panel" [attr.aria-labelledby]="'Trades tab for ' + selectedPortfolio.name">
              <app-portfolio-trades
                [selectedPortfolio]="selectedPortfolio"
                [trades]="trades"
                [tradesLoading]="tradesLoading"
                [tradesError]="tradesError">
              </app-portfolio-trades>
            </p-tabpanel>
          </p-tabpanels>
        </p-tabs>
      </div>
    </div>
  </div>
</div>