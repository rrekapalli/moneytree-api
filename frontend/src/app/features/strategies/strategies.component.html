<!-- Page Header -->
<app-page-header
  title="Trading Strategies"
  subtitle="Create and manage your automated trading strategies"
  actionButtonLabel="Create Strategy"
  actionButtonIcon="pi pi-plus"
  (actionButtonClick)="createStrategy()">
</app-page-header>

<div class="page-container">

  <!-- Two-Panel Layout -->
  <div class="two-panel-layout">
    <!-- Left Sidebar -->
    <div class="left-sidebar" role="navigation" aria-label="Strategy list">
      <!-- Search Input -->
      <div class="search-section">
        <label for="strategy-search" class="sr-only">Search strategies</label>
        <div class="search-controls">
          <span class="p-input-icon-left search-input-wrapper">
            <i class="pi pi-search" aria-hidden="true"></i>
            <input 
              id="strategy-search"
              type="text" 
              pInputText 
              [(ngModel)]="searchText" 
              (ngModelChange)="onSearchChange()"
              placeholder="Search..." 
              class="search-input"
              aria-label="Search strategies by name or description" />
          </span>
          <p-select 
            [(ngModel)]="sortField"
            [options]="sortOptions"
            (ngModelChange)="onSortFieldChange()"
            optionLabel="label"
            optionValue="value"
            appendTo="body"
            class="sort-dropdown"
            [pTooltip]="getSortLabel()"
            tooltipPosition="top"
            aria-label="Sort strategies">
            <ng-template pTemplate="selectedItem">
              <i class="pi pi-sort-alt"></i>
            </ng-template>
          </p-select>
        </div>
      </div>

      <!-- Strategy List -->
      <p-scrollpanel *ngIf="!loading" class="strategy-list-scroll" [style]="{ width: '100%', height: '100%' }">
        <div class="strategy-list" role="list" aria-label="Available strategies">
          <div 
            *ngFor="let strategy of filteredStrategies; trackBy: trackStrategyById"
            class="strategy-card"
            [class.selected]="selectedStrategy?.id === strategy.id"
            (click)="selectStrategy(strategy)"
            (keydown.enter)="selectStrategy(strategy)"
            (keydown.space)="selectStrategy(strategy); $event.preventDefault()"
            role="listitem"
            tabindex="0"
            [attr.aria-label]="'Strategy: ' + strategy.name + ', Return: ' + formatReturn(strategy.totalReturn) + ', ' + (strategy.isActive ? 'Active' : 'Inactive')"
            [attr.aria-selected]="selectedStrategy?.id === strategy.id">
            
            <div class="strategy-card-header">
              <h3 class="strategy-name">{{ strategy.name }}</h3>
              <p-tag 
                [value]="strategy.status || 'Inactive'" 
                [severity]="getStatusSeverity(strategy.status)"
                [attr.aria-label]="'Status: ' + (strategy.status || 'Inactive')">
              </p-tag>
            </div>

            <p class="strategy-description">{{ strategy.description }}</p>

            <div class="strategy-metrics">
              <div class="metric">
                <span class="metric-label">CAGR</span>
                <span 
                  class="metric-value" 
                  [style.color]="getPerformanceColor(strategy.cagr)">
                  {{ formatReturn(strategy.cagr) }}
                </span>
              </div>
              <div class="metric">
                <span class="metric-label">Sharpe</span>
                <span class="metric-value">{{ strategy.sharpeRatio?.toFixed(2) || 'N/A' }}</span>
              </div>
              <div class="metric">
                <span class="metric-label">Trades</span>
                <span class="metric-value">{{ strategy.totalTrades || 0 }}</span>
              </div>
            </div>

            <div class="strategy-footer">
              <span class="last-executed">
                <i class="pi pi-clock"></i>
                Last: {{ strategy.lastBacktestDate ? formatDate(strategy.lastBacktestDate) : 'N/A' }}
              </span>
              <span class="risk-profile">
                <i [class]="getStrategyIcon(strategy.riskProfile)"></i>
                {{ getRiskProfileLabel(strategy.riskProfile) }}
              </span>
            </div>
          </div>

          <!-- Empty State -->
          <div *ngIf="filteredStrategies.length === 0" class="empty-state" role="status" aria-live="polite">
            <i class="pi pi-inbox" aria-hidden="true"></i>
            <p>No strategies found</p>
            <p-button 
              label="Clear Filters" 
              icon="pi pi-filter-slash" 
              (onClick)="clearFilters()"
              [text]="true"
              aria-label="Clear all filters to show all strategies">
            </p-button>
          </div>
        </div>
      </p-scrollpanel>

      <!-- Loading State -->
      <div *ngIf="loading" class="loading-state" role="status" aria-live="polite" aria-busy="true">
        <i class="pi pi-spin pi-spinner" aria-hidden="true"></i>
        <p>Loading strategies...</p>
        <p *ngIf="retryCount > 0" class="retry-info">Retrying... (Attempt {{ retryCount + 1 }} of {{ maxRetries + 1 }})</p>
      </div>

      <!-- Error State -->
      <div *ngIf="error" class="error-state" role="alert" aria-live="assertive">
        <i class="pi pi-exclamation-triangle" aria-hidden="true"></i>
        <p>{{ error }}</p>
        <p-button 
          label="Retry" 
          icon="pi pi-refresh" 
          (onClick)="loadStrategies()"
          [text]="true"
          aria-label="Retry loading strategies">
        </p-button>
      </div>
    </div>

    <!-- Right Detail Panel -->
    <div class="right-panel" role="main" aria-label="Strategy details">
      <!-- Show message when no strategy is selected -->
      <div *ngIf="!selectedStrategy" class="no-selection-state" role="status">
        <i class="pi pi-chart-line" aria-hidden="true"></i>
        <h3>Select a Strategy</h3>
        <p>Choose a strategy from the list to view details and manage settings</p>
      </div>

      <!-- Show tabs when a strategy is selected -->
      <div *ngIf="selectedStrategy" class="strategy-detail">
        <p-tabs [(value)]="activeTab" (valueChange)="onTabChange($event)" role="tablist" [attr.aria-label]="'Strategy details for ' + selectedStrategy.name">
          <p-tablist>
            <p-tab value="overview" role="tab" [attr.aria-selected]="activeTab === 'overview'" [attr.aria-controls]="'overview-panel'">
              <i class="pi pi-chart-line" aria-hidden="true"></i>
              Overview
            </p-tab>
            <p-tab value="details" role="tab" [attr.aria-selected]="activeTab === 'details'" [attr.aria-controls]="'details-panel'">
              <i class="pi pi-info-circle" aria-hidden="true"></i>
              Details
            </p-tab>
            <p-tab value="configure" role="tab" [attr.aria-selected]="activeTab === 'configure'" [attr.aria-controls]="'configure-panel'">
              <i class="pi pi-cog" aria-hidden="true"></i>
              Configure
            </p-tab>
            <p-tab value="backtest-results" role="tab" [attr.aria-selected]="activeTab === 'backtest-results'" [attr.aria-controls]="'backtest-results-panel'">
              <i class="pi pi-history" aria-hidden="true"></i>
              Backtest Results
            </p-tab>
          </p-tablist>
          <p-tabpanels>
            <!-- Overview Tab -->
            <p-tabpanel value="overview" role="tabpanel" id="overview-panel" [attr.aria-labelledby]="'Overview tab for ' + selectedStrategy.name">
              <app-strategy-overview [strategy]="selectedStrategy"></app-strategy-overview>
            </p-tabpanel>

            <!-- Details Tab -->
            <p-tabpanel value="details" role="tabpanel" id="details-panel" [attr.aria-labelledby]="'Details tab for ' + selectedStrategy.name">
              <div class="tab-content">
                <h3>Details - {{ selectedStrategy.name }}</h3>
                <p>Details content will be implemented in future tasks</p>
              </div>
            </p-tabpanel>

            <!-- Configure Tab -->
            <p-tabpanel value="configure" role="tabpanel" id="configure-panel" [attr.aria-labelledby]="'Configure tab for ' + selectedStrategy.name">
              <div class="tab-content">
                <h3>Configure - {{ selectedStrategy.name }}</h3>
                <p>Configure content will be implemented in future tasks</p>
              </div>
            </p-tabpanel>

            <!-- Backtest Results Tab -->
            <p-tabpanel value="backtest-results" role="tabpanel" id="backtest-results-panel" [attr.aria-labelledby]="'Backtest Results tab for ' + selectedStrategy.name">
              <div class="tab-content">
                <h3>Backtest Results - {{ selectedStrategy.name }}</h3>
                <p>Backtest results content will be implemented in future tasks</p>
              </div>
            </p-tabpanel>
          </p-tabpanels>
        </p-tabs>
      </div>
    </div>
  </div>
</div>
