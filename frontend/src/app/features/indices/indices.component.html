<!-- Page Header -->
<app-page-header 
  title="Indices"
  subtitle="Monitor market indices and track performance"
  [showActionButton]="false">
</app-page-header>

<div class="page-container">

  <!-- Error Display -->
  @if (errorIndices()) {
    <div class="error-message p-3 mb-3 bg-red-100 border border-red-400 text-red-700 rounded">
      <h3 class="font-bold">Error Loading Indices</h3>
      <p>{{ errorIndices() }}</p>
      <button (click)="retryIndices()" class="mt-2 px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">
        Retry
      </button>
    </div>
  }

  <!-- Indices View -->
  <div class="indices-view-container">

    <!-- Tabs for Indices Lists -->
    <p-tabs [value]="activeTab()" (valueChange)="updateActiveTab($event)">
      <p-tablist>
        <div class="flex">
          @if(indicesLists().length > 0) {
            @for(indicesList of indicesLists(); track indicesList.id; let i = $index) {
              <p-tab [value]="i.toString()">
                <span>{{ i === 0 ? 'Indices' : (i + 1) }}</span>
              </p-tab>
            }
          } @else {
            <p-tab value="0">
              <span>Indices</span>
            </p-tab>
          }
        </div>
      </p-tablist>

      @if(indicesLists().length > 0) {
        @for(indicesList of indicesLists(); track indicesList.id; let i = $index) {
          <p-tabpanel [value]="i.toString()">
            <div class="indices-container mt-2" style="height: 85vh; overflow: hidden; display: flex; flex-direction: column;">
              <div class="flex justify-between items-center mb-2" style="flex-shrink: 0;">
                <!-- Loading indicator for indices -->
                @if (i === 0 && isLoadingIndices()) {
                  <div class="p-2 text-center w-full">
                    <p>Loading market indices...</p>
                  </div>
                }

                <!-- Index Selection and Stock List for main indices (first tab) -->
                @if (i === 0 && hasIndices() && !isLoadingIndices()) {
                  <div class="stock-list-container">
                    <!-- Index Selection Header with Search -->
                    <div class="flex justify-content-between align-items-center mb-2">
                      <div class="flex align-items-center">
                        <p-select
                          [options]="getIndexOptions()"
                          [ngModel]="selectedIndexForStocks()"
                          (ngModelChange)="onIndexSelectionChange($event)"
                          placeholder="Select an index..."
                          [showClear]="true"
                          [filter]="true"
                          filterPlaceholder="Search indices..."
                          optionLabel="label"
                          styleClass="p-select-sm"
                          style="width: 300px;">
                        </p-select>
                      </div>
                      <div class="flex align-items-center">
                        <span class="p-input-icon-left">
                          <input
                            type="text" 
                            pInputText 
                            [ngModel]="stockSearchQuery()" 
                            (ngModelChange)="filterStockList($event)"
                            placeholder="Search stocks..." 
                            class="p-inputtext-sm"
                            style="width: 250px;"
                            [disabled]="!selectedIndexForStocks()">
                        </span>
                      </div>
                    </div>
                    
                    <!-- Stock List Widget -->
                    @if (selectedIndexForStocks() && !isLoadingStocks()) {
                      <div class="stock-list-widget-container" style="flex: 1; overflow-y: auto;">
                        <vis-dashboard-container 
                          [widgets]="dashboardConfig || []"
                          [options]="{ editMode: false }"
                          [dashboardId]="'indices-stock-list'"
                          data-dashboard-id="indices-stock-list">
                        </vis-dashboard-container>
                      </div>
                    } @else if (isLoadingStocks()) {
                      <div class="p-4 text-center" style="flex: 1; display: flex; align-items: center; justify-content: center;">
                        <p>Loading stocks for {{ selectedIndexForStocks()?.indexName }}...</p>
                      </div>
                    } @else {
                      <div class="p-4 text-center" style="flex: 1; display: flex; align-items: center; justify-content: center;">
                        <p>Loading default index (NIFTY 50)...</p>
                      </div>
                    }
                  </div>
                }
                
                <!-- Indices List Items for other tabs -->
                @if (i !== 0 && indicesList.items.length > 0 && !(i === 0 && isLoadingIndices())) {
                  <div class="indices-list" style="flex: 1; overflow-y: auto;">
                    @for(item of indicesList.items; track $index) {
                      <div class="index-item p-2 mb-2 border-round surface-card" [pTooltip]="item.name" tooltipPosition="top">
                        <div class="grid">
                          <div class="col-12 md:col-6">
                            <div class="flex align-items-center">
                              <div class="index-symbol mr-2">{{ item.symbol }}</div>
                            </div>
                          </div>
                          <div class="col-12 md:col-4">
                            <div class="flex align-items-center justify-content-end">
                              <div class="index-price mr-2">{{ item.price | currency }}</div>
                              <div class="index-change" [ngClass]="item.change >= 0 ? 'text-green-500' : 'text-red-500'">
                                {{ item.change | percent }}
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    }
                  </div>
                }
                @if (indicesList.items.length === 0 && !(i === 0 && isLoadingIndices())) {
                  <div class="p-2 text-center" style="flex: 1; display: flex; align-items: center; justify-content: center;">
                    <p>No indices in this list yet. Use the search box above to add indices.</p>
                  </div>
                }
              </div>
          </div>
        </p-tabpanel>
        }
      }

      @if(isLoadingIndices()) {
        <p-tabpanel value="0">
          <div class="p-4 text-center" style="height: 85vh; display: flex; align-items: center; justify-content: center; overflow: hidden;">
            <p>Loading indices data...</p>
          </div>
        </p-tabpanel>
      } @else if(indicesLists().length === 0) {
        <p-tabpanel value="0">
          <div class="p-4 text-center" style="height: 85vh; display: flex; align-items: center; justify-content: center; overflow: hidden;">
            <p>No indices list found. Create your first indices list to get started.</p>
          </div>
        </p-tabpanel>
      }
    </p-tabs>
  </div>
</div>